<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Tienda - CRUD y Consultas</title>
    <style>
        /* Estilos mejorados */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f5f7fa; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        h2 { color: #3498db; margin-top: 30px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .section { background: #fff; padding: 20px; margin-bottom: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        form { margin-bottom: 20px; }
        input, select, button { padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 16px; }
        button { background: #3498db; color: white; border: none; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        button:hover { background: #2980b9; }
        .item { padding: 15px; margin-bottom: 12px; border-radius: 8px; background: #f9f9f9; border-left: 4px solid #3498db; }
        .item-header { display: flex; justify-content: space-between; align-items: center; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-group button { flex: 1; }
        .delete-btn { background: #e74c3c; }
        .delete-btn:hover { background: #c0392b; }
        .result-box { padding: 15px; background: #eaf7ff; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>üìä Sistema de Gesti√≥n de Tienda</h1>

    <div class="grid">
        <!-- Secci√≥n Clientes -->
        <div class="section">
            <h2>üë• Clientes</h2>
            <form id="form-cliente">
                <input type="hidden" name="_id">
                <input type="text" name="nombre" placeholder="Nombre completo" required>
                <input type="email" name="email" placeholder="Correo electr√≥nico" required>
                <input type="tel" name="telefono" placeholder="Tel√©fono" required>
                <input type="text" name="ciudad" placeholder="Ciudad" required>
                <button type="submit">üíæ Guardar Cliente</button>
            </form>
            <div id="lista-clientes"></div>
        </div>

        <!-- Secci√≥n Productos -->
        <div class="section">
            <h2>üì¶ Productos</h2>
            <form id="form-producto">
                <input type="hidden" name="_id">
                <input type="text" name="codigo" placeholder="C√≥digo √∫nico" required>
                <input type="text" name="nombre" placeholder="Nombre del producto" required>
                <input type="number" name="precio" placeholder="Precio ($)" step="0.01" required>
                <input type="text" name="descripcion" placeholder="Descripci√≥n">
                <input type="number" name="stock" placeholder="Cantidad en stock" required>
                <button type="submit">üíæ Guardar Producto</button>
            </form>
            <div id="lista-productos"></div>
        </div>
    </div>

    <!-- Secci√≥n Pedidos -->
    <div class="section">
        <h2>üìã Pedidos</h2>
        <form id="form-pedido">
            <select name="clienteId" required id="select-cliente"></select>
            <div id="productos-container"></div>
            <button type="button" onclick="agregarProducto()">‚ûï Agregar Producto</button>
            <select name="estado">
                <option value="pendiente">Pendiente</option>
                <option value="procesando">Procesando</option>
                <option value="completado">Completado</option>
                <option value="cancelado">Cancelado</option>
            </select>
            <button type="submit">üíæ Guardar Pedido</button>
        </form>
        <div id="lista-pedidos"></div>
    </div>

    <!-- Secci√≥n Consultas -->
    <div class="section">
        <h2>üîç Consultas</h2>
        
        <div class="grid">
            <!-- Consulta 1: Clientes por ciudad -->
            <div class="section">
                <h3>üë• Clientes por Ciudad</h3>
                <input type="text" id="ciudad-buscar" placeholder="Ingrese ciudad">
                <button onclick="buscarClientesPorCiudad()">üîç Buscar</button>
                <div class="result-box" id="resultado-ciudad"></div>
            </div>
            
            <!-- Consulta 2: Clientes por fecha -->
            <div class="section">
                <h3>üìÖ Clientes por Fecha</h3>
                <input type="date" id="fecha-buscar">
                <button onclick="buscarClientesPorFecha()">üîç Buscar</button>
                <div class="result-box" id="resultado-fecha"></div>
            </div>
            
            <!-- Consulta 3: Producto por c√≥digo -->
            <div class="section">
                <h3>üì¶ Producto por C√≥digo</h3>
                <input type="text" id="codigo-buscar" placeholder="C√≥digo del producto">
                <button onclick="buscarProductoPorCodigo()">üîç Buscar</button>
                <div class="result-box" id="resultado-codigo"></div>
            </div>
            
            <!-- Consulta 4: Pedidos por cliente -->
            <div class="section">
                <h3>üìã Pedidos por Cliente</h3>
                <select id="cliente-pedidos"></select>
                <button onclick="buscarPedidosPorCliente()">üîç Buscar</button>
                <div class="result-box" id="resultado-pedidos-cliente"></div>
            </div>
        </div>
    </div>

    <script>
    // Variables globales
    let productosDisponibles = [];
    let contadorProductos = 0;

    // ===== CLIENTES =====
    const formCliente = document.getElementById('form-cliente');
    const listaClientes = document.getElementById('lista-clientes');
    const clienteSelect = document.getElementById('select-cliente');
    const clientePedidosSelect = document.getElementById('cliente-pedidos');

    // Guardar cliente
    formCliente.addEventListener('submit', async (e) => {
        e.preventDefault();
        const datos = Object.fromEntries(new FormData(formCliente));
        if (!datos._id) delete datos._id; // Elimina _id si est√° vac√≠o
        const metodo = datos._id ? 'PUT' : 'POST';
        const url = datos._id ? `/api/clientes/${datos._id}` : '/api/clientes';
        
        try {
            const response = await fetch(url, {
                method: metodo,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error en la solicitud');
            }
            
            formCliente.reset();
            cargarClientes();
            cargarSelectsClientes();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });

    // Cargar clientes
    async function cargarClientes() {
        try {
            const res = await fetch('/api/clientes');
            const clientes = await res.json();
            
            listaClientes.innerHTML = '';
            clientes.forEach(c => {
                const fecha = new Date(c.fechaRegistro).toLocaleDateString();
                listaClientes.innerHTML += `
                    <div class='item'>
                        <div class='item-header'>
                            <strong>${c.nombre}</strong>
                            <span>${c.ciudad}</span>
                        </div>
                        <div>‚úâÔ∏è ${c.email} | üìû ${c.telefono}</div>
                        <div>üìÖ Registro: ${fecha}</div>
                        <div class='btn-group'>
                            <button onclick='editarCliente(${JSON.stringify(c)})'>‚úèÔ∏è Editar</button>
                            <button class='delete-btn' onclick='eliminarCliente("${c._id}")'>üóëÔ∏è Eliminar</button>
                        </div>
                    </div>`;
            });
        } catch (error) {
            console.error('Error cargando clientes:', error);
        }
    }

    // Cargar selects de clientes
    async function cargarSelectsClientes() {
        try {
            const res = await fetch('/api/clientes');
            const clientes = await res.json();
            
            clienteSelect.innerHTML = clientePedidosSelect.innerHTML = '';
            clientes.forEach(c => {
                const option = `<option value="${c._id}">${c.nombre} - ${c.ciudad}</option>`;
                clienteSelect.innerHTML += option;
                clientePedidosSelect.innerHTML += option;
            });
        } catch (error) {
            console.error('Error cargando selects:', error);
        }
    }

    // Editar cliente
    function editarCliente(cliente) {
        for (const key in cliente) {
            if (formCliente[key]) {
                formCliente[key].value = cliente[key];
            }
        }
    }

    // Eliminar cliente
    async function eliminarCliente(id) {
        if (!confirm('¬øEst√° seguro de eliminar este cliente?')) return;
        
        try {
            await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
            cargarClientes();
            cargarSelectsClientes();
        } catch (error) {
            alert('Error eliminando cliente: ' + error.message);
        }
    }

    // ===== PRODUCTOS =====
    const formProducto = document.getElementById('form-producto');
    const listaProductos = document.getElementById('lista-productos');

    // Guardar producto
    formProducto.addEventListener('submit', async (e) => {
        e.preventDefault();
        const datos = Object.fromEntries(new FormData(formProducto));
        if (!datos._id) delete datos._id; // Elimina _id si est√° vac√≠o
        const metodo = datos._id ? 'PUT' : 'POST';
        const url = datos._id ? `/api/productos/${datos._id}` : '/api/productos';
        
        try {
            const response = await fetch(url, {
                method: metodo,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            
            if (!response.ok) throw new Error('Error en la solicitud');
            
            formProducto.reset();
            cargarProductos();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });

    // Cargar productos
    async function cargarProductos() {
        try {
            const res = await fetch('/api/productos');
            const productos = await res.json();
            productosDisponibles = productos; // Guardar para usar en pedidos
            
            listaProductos.innerHTML = '';
            productos.forEach(p => {
                listaProductos.innerHTML += `
                    <div class='item'>
                        <div class='item-header'>
                            <strong>${p.nombre}</strong>
                            <span>$${p.precio}</span>
                        </div>
                        <div>C√≥digo: ${p.codigo} | Stock: ${p.stock}</div>
                        <div>${p.descripcion || 'Sin descripci√≥n'}</div>
                        <div class='btn-group'>
                            <button onclick='editarProducto(${JSON.stringify(p)})'>‚úèÔ∏è Editar</button>
                            <button class='delete-btn' onclick='eliminarProducto("${p._id}")'>üóëÔ∏è Eliminar</button>
                        </div>
                    </div>`;
            });
        } catch (error) {
            console.error('Error cargando productos:', error);
        }
    }

    // Editar producto
    function editarProducto(producto) {
        for (const key in producto) {
            if (formProducto[key]) {
                formProducto[key].value = producto[key];
            }
        }
    }

    // Eliminar producto
    async function eliminarProducto(id) {
        if (!confirm('¬øEst√° seguro de eliminar este producto?')) return;
        
        try {
            await fetch(`/api/productos/${id}`, { method: 'DELETE' });
            cargarProductos();
        } catch (error) {
            alert('Error eliminando producto: ' + error.message);
        }
    }

    // ===== PEDIDOS =====
    const formPedido = document.getElementById('form-pedido');
    const listaPedidos = document.getElementById('lista-pedidos');
    const productosContainer = document.getElementById('productos-container');

    // Agregar producto al pedido
    function agregarProducto() {
        contadorProductos++;
        productosContainer.innerHTML += `
            <div class="item" id="producto-${contadorProductos}">
                <select name="productos[${contadorProductos}][productoId]" required>
                    <option value="">Seleccione un producto</option>
                    ${productosDisponibles.map(p => 
                        `<option value="${p._id}">${p.nombre} ($${p.precio})</option>`
                    ).join('')}
                </select>
                <input type="number" name="productos[${contadorProductos}][cantidad]" 
                    placeholder="Cantidad" min="1" value="1" required>
                <button type="button" class="delete-btn" 
                    onclick="document.getElementById('producto-${contadorProductos}').remove()">
                    üóëÔ∏è
                </button>
            </div>`;
    }

    // Guardar pedido
    formPedido.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Recolectar datos del formulario
        const formData = new FormData(formPedido);
        const productos = [];
        
        // Procesar productos
        for (let i = 0; i <= contadorProductos; i++) {
            const productoId = formData.get(`productos[${i}][productoId]`);
            const cantidad = formData.get(`productos[${i}][cantidad]`);
            
            if (productoId && cantidad) {
                productos.push({ productoId, cantidad: parseInt(cantidad) });
            }
        }
        
        const datos = {
            clienteId: formData.get('clienteId'),
            productos,
            estado: formData.get('estado')
        };
        
        try {
            const response = await fetch('/api/pedidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            
            if (!response.ok) throw new Error('Error creando pedido');
            
            const nuevoPedido = await response.json();
            alert(`Pedido creado exitosamente! Total: $${nuevoPedido.total}`);
            formPedido.reset();
            productosContainer.innerHTML = '';
            contadorProductos = 0;
            cargarPedidos();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });

    // Cargar pedidos
    async function cargarPedidos() {
        try {
            const res = await fetch('/api/pedidos');
            const pedidos = await res.json();
            
            listaPedidos.innerHTML = '';
            pedidos.forEach(p => {
                const fecha = new Date(p.createdAt).toLocaleDateString();
                listaPedidos.innerHTML += `
                    <div class='item'>
                        <div class='item-header'>
                            <strong>Pedido #${p._id.toString().substring(0, 6)}</strong>
                            <span>$${p.total} | ${p.estado}</span>
                        </div>
                        <div>Cliente: ${p.clienteId?.nombre || 'No disponible'}</div>
                        <div>üìÖ ${fecha}</div>
                        <div><strong>Productos:</strong></div>
                        <ul>
                            ${p.productos.map(prod => 
                                `<li>${prod.productoId?.nombre || 'Producto'} - 
                                 Cantidad: ${prod.cantidad}</li>`
                            ).join('')}
                        </ul>
                    </div>`;
            });
        } catch (error) {
            console.error('Error cargando pedidos:', error);
        }
    }

    // ===== CONSULTAS =====
    async function buscarClientesPorCiudad() {
        const ciudad = document.getElementById('ciudad-buscar').value.trim();
        if (!ciudad) return alert('Ingrese una ciudad');
        
        try {
            const res = await fetch(`/api/clientes/ciudad/${ciudad}`);
            const clientes = await res.json();
            
            const resultado = clientes.length 
                ? `<ul>${clientes.map(c => `<li>${c.nombre} - ${c.email}</li>`).join('')}</ul>` 
                : 'No se encontraron clientes en esta ciudad';
                
            document.getElementById('resultado-ciudad').innerHTML = resultado;
        } catch (error) {
            alert('Error en la b√∫squeda: ' + error.message);
        }
    }

    async function buscarClientesPorFecha() {
        const fecha = document.getElementById('fecha-buscar').value;
        if (!fecha) return alert('Seleccione una fecha');
        
        try {
            const res = await fetch(`/api/clientes/fecha/${fecha}`);
            const clientes = await res.json();
            
            const resultado = clientes.length 
                ? `<ul>${clientes.map(c => `<li>${c.nombre} - ${c.ciudad}</li>`).join('')}</ul>` 
                : 'No se encontraron clientes registrados en esta fecha';
                
            document.getElementById('resultado-fecha').innerHTML = resultado;
        } catch (error) {
            alert('Error en la b√∫squeda: ' + error.message);
        }
    }

    async function buscarProductoPorCodigo() {
        const codigo = document.getElementById('codigo-buscar').value.trim();
        if (!codigo) return alert('Ingrese un c√≥digo');
        
        try {
            const res = await fetch(`/api/productos/codigo/${codigo}`);
            const producto = await res.json();
            
            const resultado = producto.nombre
                ? `<div>
                    <strong>${producto.nombre}</strong>
                    <div>C√≥digo: ${producto.codigo}</div>
                    <div>Precio: $${producto.precio}</div>
                    <div>Stock: ${producto.stock}</div>
                    <div>${producto.descripcion || ''}</div>
                   </div>`
                : 'Producto no encontrado';
                
            document.getElementById('resultado-codigo').innerHTML = resultado;
        } catch (error) {
            alert('Error en la b√∫squeda: ' + error.message);
        }
    }

    async function buscarPedidosPorCliente() {
        const clienteId = document.getElementById('cliente-pedidos').value;
        if (!clienteId) return alert('Seleccione un cliente');
        
        try {
            const res = await fetch(`/api/pedidos/cliente/${clienteId}`);
            const pedidos = await res.json();
            
            const resultado = pedidos.length 
                ? `<ul>${pedidos.map(p => `
                    <li>
                        <strong>Pedido #${p._id.toString().substring(0, 6)}</strong>
                        <div>Total: $${p.total} | Estado: ${p.estado}</div>
                        <div>Productos: ${p.productos.map(prod => 
                            `${prod.cantidad}x ${prod.productoId?.nombre || 'Producto'}`).join(', ')}
                        </div>
                    </li>`).join('')}</ul>` 
                : 'Este cliente no tiene pedidos registrados';
                
            document.getElementById('resultado-pedidos-cliente').innerHTML = resultado;
        } catch (error) {
            alert('Error en la b√∫squeda: ' + error.message);
        }
    }

    // Inicializaci√≥n
    window.onload = async () => {
        await cargarClientes();
        await cargarProductos();
        await cargarPedidos();
        cargarSelectsClientes();
    };
    </script>
</body>
</html>